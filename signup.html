<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up | Expense Tracker</title>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <script>
        (function () {
            const stored = localStorage.getItem('theme');
            const theme = stored || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>

<body>

    <!-- Container -->
    <div class="container">

        <!-- Navigation -->
        <nav class="nav">
            <a href="dashboard.html" class="nav-brand">ExpenseTracker</a>
            <button class="nav-toggle" onclick="document.querySelector('.nav-list').classList.toggle('active')"
                aria-label="Toggle navigation">â˜°</button>
            <ul class="nav-list">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="add.html" class="nav-link">Add</a></li>
                <li><a href="history.html" class="nav-link">History</a></li>
                <li><a href="login.html" class="nav-link">Login</a></li>
                <li><a href="signup.html" class="nav-btn nav-btn-primary">Signup</a></li>
            </ul>
        </nav>

        <!-- Signup Form Section -->
        <div style="max-width: 400px; margin: 3rem auto;">
            <div class="form-card">
                <h2 class="section-title" style="text-align: center; border-bottom: none; margin-bottom: 1.5rem;">Create
                    Account</h2>

                <form>
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" placeholder="eg. John Doe">
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="text" id="email" placeholder="eg. you@company.com">
                    </div>

                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" placeholder="Enter your password">
                            <button type="button" class="password-toggle" id="passwordToggle"
                                aria-label="Toggle password visibility">
                                <!-- Eye Open Icon (Default) -->
                                <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" id="signupBtn" style="margin-top: 1rem;">Create
                        Account</button>
                </form>

                <div
                    style="text-align: center; margin-top: 1.5rem; border-top: 1px solid #F3F4F6; padding-top: 1.5rem;">
                    <p style="font-size: 0.875rem; color: #6B7280;">
                        Already have an account?
                        <a href="login.html" style="color: #4F46E5; font-weight: 500; text-decoration: none;">Login</a>
                    </p>
                </div>
            </div>
        </div>

    </div>

    <script src="general.js"></script>
    <script type="module">
        import { auth, db, createUserWithEmailAndPassword, updateProfile, doc, setDoc } from './auth.js';

        const signupForm = document.querySelector('form');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signupBtn = document.getElementById('signupBtn');
        const passwordToggle = document.getElementById('passwordToggle');

        // Eye Icons
        const eyeOpen = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>`;

        const eyeClosed = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
            </svg>`;

        if (passwordToggle) {
            passwordToggle.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);

                // Toggle icon
                if (type === 'text') {
                    passwordToggle.innerHTML = eyeClosed;
                } else {
                    passwordToggle.innerHTML = eyeOpen;
                }
            });
        }

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const name = nameInput.value;

            // Hide any previous errors
            hideButtonError('signupBtn');

            // Validate inputs
            if (!name.trim()) {
                showButtonError('signupBtn', 'Please enter your full name');
                return;
            }
            if (!email.trim()) {
                showButtonError('signupBtn', 'Please enter your email address');
                return;
            }
            if (!password.trim()) {
                showButtonError('signupBtn', 'Please enter a password');
                return;
            }
            if (password.length < 6) {
                showButtonError('signupBtn', 'Password must be at least 8 characters');
                return;
            }

            // Show loading state
            signupBtn.classList.add('loading');
            signupBtn.disabled = true;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Update profile with name
                await updateProfile(user, {
                    displayName: name
                });

                // Store user data and token in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    email: user.email,
                    displayName: name,
                    token: user.accessToken,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });

                console.log("Account created for:", user.email);
                localStorage.setItem('token', user.accessToken);
                localStorage.setItem('userId', user.uid);

                window.location.href = 'dashboard.html';
            } catch (error) {
                const errorCode = error.code;
                console.error("Signup error:", errorCode, error.message);

                // Show user-friendly error messages
                let errorMsg = 'Signup failed. Please try again.';
                if (errorCode === 'auth/email-already-in-use') {
                    errorMsg = 'An account with this email already exists';
                } else if (errorCode === 'auth/invalid-email') {
                    errorMsg = 'Invalid email address';
                } else if (errorCode === 'auth/weak-password') {
                    errorMsg = 'Weak password. Use at least 6 characters and an Uppercase letter';
                } else if (errorCode === 'auth/operation-not-allowed') {
                    errorMsg = 'Account creation is currently disabled';
                }

                showButtonError('signupBtn', errorMsg);

                // Remove loading state on error
                signupBtn.classList.remove('loading');
                signupBtn.disabled = false;
            }
        });


    </script>
</body>

</html>